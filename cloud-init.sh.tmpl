#!/bin/bash -x

if [[ $(whoami) == root ]]; then
	echo "Respawning myself as non root"
	chmod 777 $0 # yay
	exec sudo -H -u ubuntu bash $0
fi

echo "Start installing actions runner ${RUNNER_VER}"

echo "User $USER, UID: $(id)"

cd # goto my home

mkdir actions-runner && cd actions-runner

curl -o actions-runner-linux-x64-${RUNNER_VER}.tar.gz -L https://github.com/actions/runner/releases/download/v${RUNNER_VER}/actions-runner-linux-x64-${RUNNER_VER}.tar.gz

tar xzf ./actions-runner-linux-x64-${RUNNER_VER}.tar.gz

./config.sh \
	--unattended \
	--replace \
	--ephemeral \
	--name "${NAME}" \
	--url "${REPO}" \
	--token "${TOKEN}"

./run.sh

sudo shutdown
